# ğŸ” VerificaÃ§Ã£o de DocumentaÃ§Ã£o - AppVisita
# Workflow para garantir que cÃ³digo e documentaÃ§Ã£o estejam sincronizados

name: ğŸ“ Documentation Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  documentation-check:
    name: ğŸ” Verificar DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # NecessÃ¡rio para comparar commits
    
    - name: ğŸ” Verificar documentaÃ§Ã£o atualizada
      run: |
        chmod +x scripts/check-docs.sh
        ./scripts/check-docs.sh
      env:
        CI: true
        GITHUB_ENV: $GITHUB_ENV
    
    - name: ğŸ Setup Python
      if: always()
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸš¨ Executar monitor de documentaÃ§Ã£o
      if: always()
      run: |
        python scripts/monitor-docs.py
      continue-on-error: true
    
    - name: ğŸ“Š Upload relatÃ³rio de documentaÃ§Ã£o
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: docs-report
        path: logs/docs-monitor-*.json
        retention-days: 30
    
    - name: ğŸ’¬ Comentar no PR (se houver problemas)
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Ler logs se existirem
          let reportContent = '';
          try {
            const logFiles = fs.readdirSync('logs').filter(f => f.startsWith('docs-monitor-'));
            if (logFiles.length > 0) {
              const latestLog = logFiles.sort().pop();
              const logData = JSON.parse(fs.readFileSync(`logs/${latestLog}`, 'utf8'));
              
              reportContent = `
## ğŸš¨ Problemas de DocumentaÃ§Ã£o Detectados

### Resumo
- âŒ Erros: ${logData.errors?.length || 0}
- âš ï¸ Warnings: ${logData.warnings?.length || 0}

### Erros Encontrados
${logData.errors?.map(error => `- âŒ ${error}`).join('\n') || 'Nenhum'}

### Warnings
${logData.warnings?.map(warning => `- âš ï¸ ${warning}`).join('\n') || 'Nenhum'}

### ğŸ“ AÃ§Ã£o NecessÃ¡ria
1. Verifique quais documentos precisam ser atualizados
2. Consulte \`docs/DOCUMENTATION_UPDATE.md\` para o processo
3. Atualize a documentaÃ§Ã£o relevante antes do merge

---
*VerificaÃ§Ã£o automÃ¡tica de documentaÃ§Ã£o*
              `;
            }
          } catch (e) {
            reportContent = `
## âš ï¸ VerificaÃ§Ã£o de DocumentaÃ§Ã£o

A verificaÃ§Ã£o de documentaÃ§Ã£o encontrou problemas. Por favor:

1. ğŸ“ Verifique se a documentaÃ§Ã£o foi atualizada junto com o cÃ³digo
2. ğŸ” Execute \`./scripts/check-docs.sh\` localmente
3. ğŸ“‹ Consulte \`docs/DOCUMENTATION_UPDATE.md\` para detalhes

---
*Para mais informaÃ§Ãµes, verifique os logs do CI/CD*
            `;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: reportContent
          });

  documentation-monitor:
    name: ğŸ“Š Monitor de DocumentaÃ§Ã£o
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # SÃ³ no main branch
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸš¨ Executar monitor completo
      run: |
        python scripts/monitor-docs.py --send-alerts
      env:
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        FROM_PASSWORD: ${{ secrets.FROM_PASSWORD }}
        ALERT_EMAILS: ${{ secrets.ALERT_EMAILS }}
    
    - name: ğŸ“Š Salvar relatÃ³rio como artifact
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: docs-monitoring-report
        path: logs/docs-monitor-*.json
        retention-days: 90

  templates-validation:
    name: ğŸ§ª Validar Templates
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v3
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ” Verificar templates existem
      run: |
        python scripts/create-docs.py <<EOF
        5
        0
        EOF
    
    - name: ğŸ“ Testar criaÃ§Ã£o de documentaÃ§Ã£o
      run: |
        # Teste automatizado de criaÃ§Ã£o de docs
        python scripts/create-docs.py <<EOF
        1
        Funcionalidade de Teste CI
        app-test.js  
        Bot do CI
        v1.0.0
        Teste automatizado de documentaÃ§Ã£o
        0
        EOF
        
        # Verificar se arquivo foi criado
        if [ -f "docs/features/FEATURE_funcionalidade_de_teste_ci.md" ]; then
          echo "âœ… Template de funcionalidade funcionando"
        else
          echo "âŒ Falha no template de funcionalidade"
          exit 1
        fi
    
    - name: ğŸ§¹ Limpar arquivos de teste
      if: always()
      run: |
        rm -f docs/features/FEATURE_funcionalidade_de_teste_ci.md
        rm -f docs/bugfixes/BUGFIX_*.md
        rm -f docs/api/API_*.md 