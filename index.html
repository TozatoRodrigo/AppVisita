<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4285f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- SEO & Meta -->
    <title>AppVisita - Sistema Profissional de Gest√£o M√©dica</title>
    <meta name="description" content="Sistema completo de gest√£o m√©dica com evolu√ß√µes, equipes e anexos. Seguro, eficiente e compat√≠vel com LGPD.">
    <meta name="keywords" content="sistema m√©dico, gest√£o hospitalar, evolu√ß√µes m√©dicas, prontu√°rio eletr√¥nico">
    <meta name="author" content="AppVisita Team">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/enterprise-components.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="estilos-admin.css">
    
    <!-- Icons -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè•</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- Core Scripts -->
    <script src="script-otimizado.js"></script>
    <script src="js/services/AuditService.js"></script>
    <script src="js/services/ValidationService.js"></script>
    <script src="js/services/MonitoringService.js"></script>
    <script src="js/services/SecurityService.js"></script>
    
    <!-- Application Scripts -->
    <script src="app-modulos.js"></script>
    <script src="app-ui.js"></script>
    <script src="js/admin-dashboard.js"></script>
    
    <!-- Global Variables -->
    <script>
        window.APP_VERSION = '2.0.0';
        window.BUILD_ID = 'build_' + Date.now();
        window.ENVIRONMENT = window.location.hostname === 'localhost' ? 'development' : 'production';
    </script>
    
    <!-- Firebase Initialization Checker -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ AppVisita v2.0.0 - Verificando inicializa√ß√£o...");
            
            if (typeof window.verificarFirebaseDisponivel !== 'function') {
                console.error("‚ùå Fun√ß√£o de verifica√ß√£o do Firebase n√£o encontrada!");
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert--error';
                errorMsg.style.cssText = 'position:fixed;top:0;left:0;width:100%;z-index:9999;';
                errorMsg.innerHTML = `
                    <div class="alert__content">
                        <div class="alert__title">Erro Cr√≠tico</div>
                        <div class="alert__message">Fun√ß√£o de verifica√ß√£o do Firebase n√£o encontrada. Recarregue a p√°gina.</div>
                    </div>
                `;
                document.body.appendChild(errorMsg);
                return;
            }
            
            if (!window.verificarFirebaseDisponivel()) {
                console.log("‚è≥ Firebase aguardando inicializa√ß√£o...");
                
                document.addEventListener('firebase-ready', function(event) {
                    console.log("‚úÖ Firebase inicializado:", event?.detail);
                    
                    // Inicializar auditoria
                    if (window.AuditService) {
                        window.AuditService.logSecurityEvent('app_start', {
                            version: window.APP_VERSION,
                            environment: window.ENVIRONMENT,
                            userAgent: navigator.userAgent
                        }, 'info');
                    }
                });
                
                setTimeout(function() {
                    if (!window.verificarFirebaseDisponivel()) {
                        console.error("‚ùå Timeout de inicializa√ß√£o do Firebase!");
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert--error';
                        errorMsg.style.cssText = 'position:fixed;top:0;left:0;width:100%;z-index:9999;';
                        errorMsg.innerHTML = `
                            <div class="alert__content">
                                <div class="alert__title">Erro de Conectividade</div>
                                <div class="alert__message">Firebase n√£o inicializou em 10 segundos. Verifique sua conex√£o.</div>
                            </div>
                        `;
                        document.body.appendChild(errorMsg);
                    }
                }, 10000);
            } else {
                console.log("‚úÖ Firebase j√° dispon√≠vel");
            }
        });
    </script>
    
    <!-- Application State Monitor -->
    <script>
      (function() {
        window.addEventListener('load', function() {
          console.log('üîç Verificando estado da aplica√ß√£o...');
          
          setTimeout(function() {
            const areaLogin = document.getElementById('area-login');
            const appContainer = document.getElementById('app-container');
            const loading = document.getElementById('loading-overlay');
            
            if (areaLogin && appContainer) {
              const areaLoginVisible = areaLogin.style.display !== 'none';
              const appContainerVisible = appContainer.style.display !== 'none';
              
              if ((!areaLoginVisible && !appContainerVisible) || (areaLoginVisible && appContainerVisible)) {
                console.warn('‚ö†Ô∏è Estado inconsistente detectado - corrigindo...');
                
                if (!window.firebase || !window.firebase.auth) {
                  console.error('‚ùå Firebase n√£o inicializado - recarregando...');
                  location.reload();
                  return;
                }
                
                const currentUser = window.firebase.auth().currentUser;
                if (!currentUser) {
                  console.log('üë§ Usu√°rio n√£o autenticado - mostrando login');
                  areaLogin.style.display = 'flex';
                  appContainer.style.display = 'none';
                } else {
                  console.log('‚úÖ Usu√°rio autenticado - mostrando dashboard');
                  areaLogin.style.display = 'none';
                  appContainer.style.display = 'block';
                }
              }
              
              if (loading && loading.style.display !== 'none') {
                console.warn('‚è∞ Loading vis√≠vel por muito tempo - escondendo...');
                loading.style.display = 'none';
              }
            } else {
              console.error('‚ùå Elementos essenciais da UI n√£o encontrados!');
            }
          }, 5000);
        });
      })();
    </script>

    <!-- Test Suite (apenas em desenvolvimento) -->
    <script>
        if (window.location.hostname === 'localhost' || window.location.search.includes('test=true')) {
            const testScript = document.createElement('script');
            testScript.src = 'tests/test-suite.js';
            document.head.appendChild(testScript);
        }
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
      <div class="loading-spinner"></div>
      <div id="loading-message" class="loading-message">Carregando AppVisita...</div>
    </div>

    <!-- Login Section -->
    <section id="area-login" class="login-container">
        <div class="login-card card">
            <div class="card__header text-center">
                <img src="https://cdn-icons-png.flaticon.com/512/4253/4253264.png" alt="AppVisita Logo" class="logo">
                <h1 class="card__title">AppVisita</h1>
                <p class="card__subtitle">Sistema Profissional de Gest√£o M√©dica</p>
            </div>
            
            <div class="card__content">
                <form id="form-login">
                    <div class="form-group">
                        <label for="login-email" class="form-label form-label--required">Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="Seu email m√©dico" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-senha" class="form-label form-label--required">Senha</label>
                        <input type="password" id="login-senha" class="form-control" placeholder="Sua senha" required>
                    </div>
                    
                    <button type="submit" class="btn btn--primary btn--lg w-full">
                        <i class="fas fa-sign-in-alt"></i>
                        Entrar
                    </button>
                    
                    <div id="login-error-message" class="form-error-text" style="display: none;"></div>
                </form>
            </div>
            
            <div class="card__actions">
                <p class="text-sm text-neutral-600">
                    N√£o tem conta? 
                    <button id="btn-criar-conta" class="btn btn--ghost btn--sm">
                        Crie uma aqui
                    </button>
                </p>
                <div id="auth-message" class="form-help-text"></div>
            </div>
        </div>
    </section>

    <!-- Main Application -->
    <div id="app-container" style="display: none;">
        <!-- Sidebar / Menu lateral -->
        <div id="sidebar">
            <div class="sidebar-header">
                <h3>AppVisita</h3>
                <span class="badge badge--primary">v2.0</span>
                <button id="close-sidebar" class="btn btn--ghost btn--sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <nav id="menu-principal">
                <ul class="nav-list">
                    <li>
                        <button id="btn-dashboard" class="btn btn--ghost btn--lg menu-btn menu-btn-active">
                            <i class="fas fa-home"></i> 
                            Dashboard
                        </button>
                    </li>
                    <li>
                        <button id="btn-adicionar-novo" class="btn btn--ghost btn--lg menu-btn">
                            <i class="fas fa-user-plus"></i> 
                            Adicionar Paciente
                        </button>
                    </li>
                    <li>
                        <button id="btn-consultar" class="btn btn--ghost btn--lg menu-btn">
                            <i class="fas fa-search"></i> 
                            Consultar Paciente
                        </button>
                    </li>
                    <li class="nav-divider"></li>
                    <li>
                        <button id="btn-logout" class="btn btn--error btn--lg menu-btn-logout">
                            <i class="fas fa-sign-out-alt"></i> 
                            Sair
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
        
        <!-- Overlay para quando o menu estiver aberto -->
        <div id="sidebar-overlay"></div>

        <header class="app-header">
            <button id="menu-toggle" class="btn btn--ghost btn--md">
                <i class="fas fa-bars"></i>
            </button>
            
            <h1 class="app-title">AppVisita</h1>
            
            <div class="header-actions">
                <button id="theme-toggle" class="btn btn--ghost btn--md" title="Alternar tema">
                    <i class="fas fa-moon"></i>
                </button>
                
                <div class="user-menu">
                    <button id="user-menu-toggle" class="btn btn--ghost btn--md">
                        <i class="fas fa-user-circle"></i>
                        <span id="user-name">Usu√°rio</span>
                    </button>
                </div>
            </div>
        </header>
        
        <main class="app-main">
            <!-- Dashboard (vis√≠vel por padr√£o) -->
            <section id="dashboard-section" class="app-section active-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-clipboard-list"></i> 
                        Dashboard M√©dico
                    </h2>
                    
                    <div class="section-actions">
                        <div class="form-group">
                            <label for="ordenar-por" class="form-label">Ordenar por:</label>
                            <select id="ordenar-por" class="form-control">
                                <option value="adicao">Ordem de Adi√ß√£o</option>
                                <option value="nome">Nome (A-Z)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o de Pacientes Pendentes de Visita -->
                <div class="dashboard-section" id="pacientes-pendentes">
                    <div class="section-subtitle">
                        <h3>
                            <i class="fas fa-hourglass-half"></i>
                            Pendentes de Visita 
                            <span id="contador-pendentes" class="contador-badge">0</span>
                        </h3>
                    </div>
                    <div id="lista-pacientes-pendentes" class="patients-grid">
                        <!-- Pacientes pendentes ser√£o adicionados aqui -->
                    </div>
                </div>

                <!-- Se√ß√£o de Pacientes J√° Visitados -->
                <div class="dashboard-section" id="pacientes-visitados" style="margin-top: 30px;">
                    <div class="section-subtitle">
                        <h3>
                            <i class="fas fa-check-circle"></i>
                            Visitados Hoje 
                            <span id="contador-visitados" class="contador-badge">0</span>
                        </h3>
                    </div>
                    <div id="lista-pacientes-visitados" class="patients-grid">
                        <!-- Pacientes visitados ser√£o adicionados aqui -->
                    </div>
                </div>
            </section>
            
            <!-- Adicionar Paciente (oculto inicialmente) -->
            <section id="adicionar-paciente-section" class="app-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-user-plus"></i> 
                        Adicionar Novo Paciente
                    </h2>
                </div>
                
                <div class="card">
                    <form id="form-adicionar-paciente" class="card__content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="nome-paciente" class="form-label form-label--required">Nome do Paciente</label>
                                <input type="text" id="nome-paciente" class="form-control" required placeholder="Nome completo do paciente">
                                <div class="form-help-text">Nome completo sem abrevia√ß√µes</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="cpf-paciente" class="form-label">CPF</label>
                                <input type="text" id="cpf-paciente" class="form-control" placeholder="000.000.000-00">
                                <div class="form-help-text">Opcional, mas recomendado</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="data-nascimento-paciente" class="form-label">Data de Nascimento</label>
                                <input type="date" id="data-nascimento-paciente" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="id-internacao-paciente" class="form-label">ID/Leito de Interna√ß√£o</label>
                                <input type="text" id="id-internacao-paciente" class="form-control" placeholder="Ex: Leito 101, UTI 05">
                            </div>
                            
                            <div class="form-group">
                                <label for="local-paciente" class="form-label">Local de Interna√ß√£o</label>
                                <input type="text" id="local-paciente" class="form-control" placeholder="Ex: UTI, Enfermaria, CTI">
                                <div class="form-help-text">Setor ou unidade onde o paciente est√° internado</div>
                            </div>
                        </div>
                        
                        <div id="pacientes-sugeridos" class="suggestions-container"></div>
                        <div id="msg-paciente-existente" class="alert alert--warning" style="display: none;"></div>
                        
                        <div class="card__actions">
                            <button type="submit" id="btn-adicionar-paciente" class="btn btn--primary btn--lg">
                                <i class="fas fa-plus"></i>
                                Adicionar Paciente
                            </button>
                        </div>
                    </form>
                </div>
            </section>
            
            <!-- Consultar Paciente (oculto inicialmente) -->
            <section id="consultar-paciente-section" class="app-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-search"></i> 
                        Consultar Paciente
                    </h2>
                </div>
                
                <div class="card">
                    <div class="card__content">
                        <div class="search-container">
                            <div class="form-group">
                                <label for="consulta-termo" class="form-label">Buscar paciente</label>
                                <div class="input-group">
                                    <input type="text" id="consulta-termo" class="form-control" placeholder="Digite nome, CPF ou ID de interna√ß√£o">
                                    <button id="btn-buscar-paciente" class="btn btn--primary">
                                        <i class="fas fa-search"></i>
                                        Buscar
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resultado-consulta" class="search-results">
                            <!-- Resultados da busca -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts da aplica√ß√£o -->
    <script src="app-login.js"></script>
    <script src="app-pacientes.js"></script>
    <script src="app-diagnostico.js"></script>
    <script src="app-equipes.js"></script>
    <script src="app-admin.js"></script>
    
    <!-- Error Boundary -->
    <script>
        window.addEventListener('error', function(event) {
            console.error('‚ùå Erro capturado:', event.error);
            
            if (window.AuditService) {
                window.AuditService.logSecurityEvent('javascript_error', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    stack: event.error?.stack
                }, 'error');
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            console.error('‚ùå Promise rejeitada:', event.reason);
            
            if (window.AuditService) {
                window.AuditService.logSecurityEvent('promise_rejection', {
                    reason: event.reason?.toString(),
                    stack: event.reason?.stack
                }, 'error');
            }
        });
    </script>

    <!-- Modal de Evolu√ß√£o -->
    <div id="modal-evolucao" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo-paciente">Registrar Evolu√ß√£o</h2>
                <button class="close-button">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="form-evolucao">
                    <input type="hidden" id="paciente-id-evolucao" name="pacienteId">
                    
                    <!-- Texto da Evolu√ß√£o -->
                    <div class="form-group">
                        <label for="texto-evolucao" class="form-label form-label--required">Evolu√ß√£o do Paciente</label>
                        <textarea id="texto-evolucao" class="form-control" rows="8" placeholder="Descreva a evolu√ß√£o do paciente..." required></textarea>
                        <div class="form-help-text">Descreva detalhadamente o estado atual e evolu√ß√£o do paciente</div>
                    </div>
                    
                    <!-- Status do Paciente -->
                    <div class="form-group">
                        <label for="status-paciente" class="form-label form-label--required">Status do Paciente</label>
                        <select id="status-paciente" class="form-control" required>
                            <option value="">Selecione o status</option>
                            <option value="internado">Continua Internado</option>
                            <option value="alta">Alta Hospitalar</option>
                            <option value="obito">√ìbito</option>
                        </select>
                    </div>
                    
                    <!-- Upload de Imagens -->
                    <div class="form-group">
                        <label class="form-label">Anexar Imagens (opcional)</label>
                        <div id="upload-area" class="upload-area">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <p class="upload-text">Clique aqui ou arraste imagens para anexar</p>
                                <p class="upload-help">Formatos: JPG, PNG, GIF | M√°ximo: 10 imagens | Tamanho m√°ximo: 5MB cada</p>
                            </div>
                            <input type="file" id="input-imagens" multiple accept="image/*" style="display: none;">
                        </div>
                        
                        <!-- Preview das Imagens -->
                        <div id="preview-imagens" class="preview-container"></div>
                        
                        <!-- Progresso do Upload -->
                        <div id="progress-upload" class="upload-progress" style="display: none;">
                            <div class="progress-bar">
                                <div id="progress-bar-fill" class="progress-fill"></div>
                            </div>
                            <div id="progress-text" class="progress-text">Fazendo upload...</div>
                        </div>
                    </div>
                    
                    <!-- Bot√µes -->
                    <div class="modal-actions">
                        <button type="button" class="btn btn--ghost close-button">Cancelar</button>
                        <button type="submit" class="btn btn--primary">
                            <i class="fas fa-save"></i>
                            Salvar Evolu√ß√£o
                        </button>
                    </div>
                </form>
                
                <!-- Hist√≥rico de Evolu√ß√µes -->
                <div class="historico-section">
                    <h3>Hist√≥rico de Evolu√ß√µes</h3>
                    <div id="historico-evolucoes" class="historico-container">
                        <!-- Evolu√ß√µes anteriores ser√£o carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Visualiza√ß√£o de Imagem -->
    <div id="modal-imagem" class="modal modal-imagem" style="display: none;">
        <div class="modal-imagem-content">
            <button class="modal-imagem-close">&times;</button>
            <button class="modal-imagem-nav modal-imagem-prev">&#8249;</button>
            <button class="modal-imagem-nav modal-imagem-next">&#8250;</button>
            
            <div class="modal-imagem-container">
                <img id="modal-imagem-img" src="" alt="Imagem">
                <div class="modal-imagem-info">
                    <span id="modal-imagem-counter">1 / 1</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Testes Regressivos (apenas em desenvolvimento) -->
    <script>
        // Carregar testes regressivos apenas em desenvolvimento
        if (window.location.hostname === 'localhost' || 
            window.location.hostname === '127.0.0.1' || 
            window.location.search.includes('enable_tests=true')) {
            
            console.log('üß™ Carregando sistema de testes regressivos...');
            
            // Carregar framework de testes
            const scripts = [
                'tests/regression-framework.js',
                'tests/regression-runner.js',
                'tests/auto-test-updater.js',
                'tests/auto-integration.js'
            ];
            
            scripts.forEach(scriptSrc => {
                const script = document.createElement('script');
                script.src = scriptSrc;
                script.onerror = () => console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel carregar: ${scriptSrc}`);
                document.head.appendChild(script);
            });
            
            // Configurar atualiza√ß√£o autom√°tica ap√≥s carregamento
            window.addEventListener('load', () => {
                setTimeout(() => {
                    if (window.autoTestUpdater && window.autoIntegration) {
                        console.log('ü§ñ Sistema de atualiza√ß√£o autom√°tica de testes ativo!');
                        console.log('üí° Comandos dispon√≠veis:');
                        console.log('   - autoTestUpdater.runCompleteUpdate() - Gerar novos testes');
                        console.log('   - autoIntegration.runAutoIntegrationFromFiles() - Integra√ß√£o completa');
                        console.log('   - URL: ?auto_integrate=true - Integra√ß√£o autom√°tica a cada 30min');
                    }
                }, 1000);
            });
        }
    </script>
</body>
</html> 